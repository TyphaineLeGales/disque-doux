import React from 'react';
import { View } from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import Animated, { useAnimatedStyle, withTiming } from 'react-native-reanimated';
import Svg, { Path, G, Defs, Filter, FeFlood, FeColorMatrix, FeOffset, FeGaussianBlur, FeComposite, FeBlend } from 'react-native-svg';

type ProgressBarProps = {
  currentPhase: number;
  totalPhases: number;
  phaseProgress: number;
};

const COLORS = {
  completed: '#EC7611',
  background: '#E8C29C',
} as const;

const ValidateIcon = () => (
  <Svg width="54" height="54" viewBox="0 0 54 54" fill="none">
    <Path d="M22.2555 5.37292C23.2911 4.28198 24.9656 4.1044 26.2069 4.95388L31.1647 8.3465C31.6966 8.71052 32.3299 8.89745 32.9743 8.88068L38.9796 8.72438C40.4833 8.68525 41.7929 9.74372 42.07 11.2222L43.1768 17.1268C43.2955 17.7603 43.6111 18.3403 44.0786 18.784L48.4355 22.92C49.5265 23.9556 49.7041 25.6301 48.8546 26.8714L45.462 31.8292C45.0979 32.3611 44.911 32.9944 44.9278 33.6387L45.0841 39.6441C45.1232 41.1478 44.0647 42.4574 42.5863 42.7345L36.6817 43.8412C36.0481 43.96 35.4682 44.2756 35.0244 44.7431L30.8885 49.1C29.8529 50.191 28.1784 50.3685 26.937 49.5191L21.9793 46.1265C21.4473 45.7624 20.8141 45.5755 20.1697 45.5923L14.1643 45.7486C12.6607 45.7877 11.3511 44.7292 11.074 43.2508L9.96723 37.3462C9.84848 36.7126 9.5329 36.1327 9.06541 35.6889L4.70844 31.553C3.6175 30.5174 3.43992 28.8429 4.2894 27.6015L7.68202 22.6438C8.04604 22.1118 8.23297 21.4786 8.2162 20.8342L8.0599 14.8288C8.02077 13.3251 9.07924 12.0155 10.5577 11.7384L16.4623 10.6317C17.0958 10.513 17.6758 10.1974 18.1196 9.72989L22.2555 5.37292Z" fill="#FCCB43"/>
    <Path d="M22.3342 6.11382C23.3698 5.02288 25.0443 4.84531 26.2857 5.69479L30.9954 8.91767C31.5274 9.28169 32.1606 9.46862 32.805 9.45185L38.5099 9.30338C40.0136 9.26424 41.3232 10.3227 41.6003 11.8012L42.6517 17.4104C42.7704 18.0439 43.086 18.6239 43.5535 19.0676L47.6925 22.9967C48.7834 24.0322 48.961 25.7067 48.1115 26.9481L44.8886 31.6578C44.5246 32.1898 44.3377 32.823 44.3544 33.4674L44.5029 39.1723C44.5421 40.676 43.4836 41.9856 42.0051 42.2627L36.3959 43.3141C35.7624 43.4328 35.1824 43.7484 34.7387 44.2159L30.8096 48.3549C29.774 49.4458 28.0996 49.6234 26.8582 48.7739L22.1485 45.551C21.6165 45.187 20.9833 45.0001 20.3389 45.0168L14.634 45.1653C13.1303 45.2045 11.8207 44.146 11.5436 42.6675L10.4922 37.0583C10.3735 36.4248 10.0579 35.8448 9.59041 35.4011L5.45142 31.472C4.36048 30.4365 4.18291 28.762 5.03238 27.5206L8.25527 22.8109C8.61929 22.2789 8.80622 21.6457 8.78945 21.0013L8.64097 15.2964C8.60184 13.7927 9.66031 12.4831 11.1388 12.206L16.748 11.1546C17.3815 11.0359 17.9615 10.7203 18.4052 10.2528L22.3342 6.11382Z" stroke="#EC7611" strokeWidth="1.02104"/>
    <Path d="M21.921 34.1876C21.9434 34.2175 21.9524 34.253 21.9766 34.2818C22.0117 34.321 22.0583 34.3391 22.0984 34.3705C22.1456 34.4098 22.1917 34.4473 22.2442 34.4775C22.2957 34.5058 22.3476 34.5267 22.4031 34.5456C22.4814 34.5748 22.5592 34.5949 22.6413 34.604C22.6752 34.6067 22.7085 34.6062 22.7432 34.6061C22.8469 34.6073 22.9472 34.5924 23.0501 34.5617C23.0682 34.5558 23.0839 34.5477 23.102 34.5419C23.1701 34.5172 23.24 34.5036 23.3033 34.4626C23.3485 34.4336 23.3768 34.3881 23.416 34.353C23.4178 34.3519 23.421 34.3513 23.4213 34.3498L35.3256 23.0213C35.4248 22.9308 35.5051 22.8217 35.5621 22.7002C35.6191 22.5787 35.6516 22.4472 35.6577 22.3131C35.6639 22.1791 35.6436 22.0451 35.598 21.9189C35.5523 21.7927 35.4823 21.6767 35.3919 21.5776C35.3014 21.4784 35.1923 21.3981 35.0708 21.3411C34.9493 21.2841 34.8178 21.2516 34.6837 21.2455C34.5497 21.2393 34.4157 21.2596 34.2895 21.3053C34.1633 21.3509 34.0473 21.4209 33.9482 21.5113L22.9531 31.9739L19.7296 26.679C19.657 26.5662 19.5629 26.4689 19.4527 26.3925C19.3425 26.3161 19.2183 26.2622 19.0873 26.2338C18.9562 26.2054 18.8209 26.2031 18.6889 26.227C18.557 26.2509 18.431 26.3005 18.3183 26.3731C18.2055 26.4457 18.1082 26.5398 18.0318 26.65C17.9554 26.7602 17.9015 26.8844 17.8731 27.0154C17.8447 27.1465 17.8423 27.2818 17.8663 27.4138C17.8902 27.5457 17.9398 27.6717 18.0124 27.7844L21.8901 34.1555C21.8974 34.168 21.9108 34.1744 21.921 34.1876Z" fill="#EC7611"/>
  </Svg>
);

const CurrentIcon = () => (
  <Svg width="56" height="55" viewBox="0 0 56 55" fill="none">
    <G filter="url(#filter0_d_168_4138)">
      <Path d="M30.3495 6.94453C32.7362 5.53988 35.8117 6.38701 37.1425 8.81562C37.9708 10.3272 39.5314 11.2934 41.2537 11.3611C44.0209 11.4697 46.1502 13.8451 45.9567 16.6077C45.8363 18.3271 46.6268 19.9837 48.0391 20.9717C50.3083 22.5592 50.8153 25.7087 49.159 27.9281C48.1281 29.3095 47.8975 31.1304 48.5515 32.7252C49.6022 35.2875 48.326 38.2111 45.7327 39.1827C44.1186 39.7875 43.5002 41.6104 40.4621 41.8594C40.1812 43.3854 38.6319 42.1178 37.3687 42.7985C36.3773 43.3327 35.9187 43.8557 35.3679 45.502C33.3268 47.102 33.3286 46.9811 32.1496 48.2385C30.2553 50.2586 27.0658 50.3123 25.1046 48.357C23.884 47.14 22.1144 46.6526 20.4428 47.0729C17.7571 47.7483 15.0448 46.069 14.4521 43.3638C14.0833 41.6801 12.8581 40.3134 11.2246 39.7632C8.6001 38.8794 7.2263 36.0003 8.19022 33.4042C8.79017 31.7883 8.49843 29.9761 7.42166 28.6302C5.69165 26.4677 6.09246 23.303 8.30696 21.6401C9.68527 20.6051 10.4196 18.9229 10.2414 17.2085C9.95514 14.454 12.0033 12.0083 14.7653 11.8066C16.4844 11.6811 18.0116 10.663 18.7886 9.12437C20.0369 6.65237 23.0822 5.70228 25.5148 7.02586C27.0288 7.84967 28.864 7.8188 30.3495 6.94453Z" fill="#FF3E03"/>
      <Path d="M30.6859 10.2243C32.1057 9.38866 33.9354 9.89263 34.7271 11.3374L35.5985 12.9277C36.0913 13.8269 37.0197 14.4018 38.0444 14.442L39.8563 14.5132C41.5026 14.5778 42.7693 15.991 42.6542 17.6345L42.5276 19.4434C42.4559 20.4663 42.9262 21.4518 43.7664 22.0396L45.2523 23.0791C46.6022 24.0235 46.9039 25.8972 45.9185 27.2176L44.834 28.6708C44.2207 29.4926 44.0835 30.5759 44.4725 31.5247L45.1605 33.2025C45.7856 34.7268 45.0264 36.4661 43.4836 37.0442L41.7855 37.6804C40.8253 38.0402 40.1242 38.8773 39.9385 39.8858L39.6102 41.6692C39.312 43.2895 37.7329 44.3422 36.1225 43.9944L34.3501 43.6116C33.3477 43.3951 32.3053 43.7204 31.6039 44.4684L30.3636 45.7912C29.2367 46.993 27.3391 47.0249 26.1724 45.8617L24.8883 44.5813C24.1621 43.8573 23.1094 43.5674 22.1149 43.8174L20.3563 44.2596C18.7585 44.6614 17.1449 43.6624 16.7923 42.053L16.4043 40.2817C16.1848 39.2801 15.4559 38.4669 14.4841 38.1397L12.7656 37.5609C11.2043 37.0351 10.387 35.3223 10.9604 33.7778L11.5916 32.0778C11.9485 31.1165 11.775 30.0384 11.1344 29.2377L10.0016 27.8218C8.97235 26.5353 9.2108 24.6525 10.5282 23.6632L11.9783 22.5744C12.7983 21.9586 13.2351 20.9579 13.1291 19.9379L12.9417 18.1343C12.7714 16.4956 13.9899 15.0406 15.633 14.9206L17.4415 14.7886C18.4642 14.7139 19.3728 14.1082 19.8351 13.1929L20.6525 11.5742C21.3952 10.1036 23.2068 9.53835 24.654 10.3258L26.2468 11.1925C27.1476 11.6825 28.2394 11.6642 29.1231 11.1441L30.6859 10.2243Z" fill="#FF3E03" stroke="#FCCB43" strokeWidth="0.973199"/>
      <Path d="M33.0291 47.5339L46.0111 39.131C44.5637 38.6505 40.1514 37.5262 37.361 39.0911C34.5707 40.6559 33.5381 45.7212 33.0291 47.5339Z" fill="white"/>
      <Path d="M23.7782 35.0162C23.8021 35.0444 23.813 35.0789 23.8386 35.106C23.8756 35.1427 23.9227 35.1578 23.9641 35.1866C24.013 35.2226 24.0607 35.257 24.1143 35.2837C24.1668 35.3087 24.2193 35.3264 24.2752 35.3417C24.3543 35.3661 24.4323 35.3814 24.5138 35.3856C24.5476 35.3863 24.5804 35.3839 24.6147 35.3818C24.7172 35.3769 24.8154 35.3564 24.9153 35.32C24.9328 35.3132 24.9478 35.3043 24.9653 35.2975C25.0312 35.2692 25.0994 35.2516 25.1596 35.2075C25.2025 35.1762 25.2278 35.1296 25.2645 35.0927C25.2662 35.0915 25.2693 35.0907 25.2696 35.0892L36.3695 23.2078C36.4622 23.1127 36.5353 23.0003 36.5845 22.8769C36.6337 22.7536 36.6582 22.6218 36.6564 22.489C36.6547 22.3563 36.6269 22.2251 36.5745 22.1031C36.5221 21.9811 36.4462 21.8706 36.3511 21.778C36.256 21.6853 36.1436 21.6122 36.0202 21.563C35.8969 21.5138 35.7651 21.4893 35.6323 21.4911C35.4996 21.4928 35.3684 21.5206 35.2464 21.573C35.1244 21.6254 35.0139 21.7013 34.9212 21.7964L24.669 32.7696L21.1773 27.727C21.0991 27.6199 21.0005 27.5292 20.8872 27.4601C20.7739 27.3911 20.6481 27.345 20.517 27.3246C20.3859 27.3041 20.2521 27.3097 20.1232 27.341C19.9942 27.3723 19.8727 27.4287 19.7656 27.5069C19.6584 27.5852 19.5677 27.6837 19.4987 27.797C19.4296 27.9103 19.3836 28.0361 19.3631 28.1672C19.3427 28.2983 19.3483 28.4321 19.3796 28.5611C19.4108 28.69 19.4672 28.8115 19.5455 28.9187L23.7458 34.9863C23.7538 34.9981 23.7674 35.0038 23.7782 35.0162Z" fill="#FCCB43"/>
    </G>
    <Defs>
      <Filter id="filter0_d_168_4138" x="1.03676" y="1.97724" width="52.3644" height="52.1002" filterUnits="userSpaceOnUse">
        <FeFlood floodOpacity="0" result="BackgroundImageFix"/>
        <FeColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <FeOffset dx="-1.02104"/>
        <FeGaussianBlur stdDeviation="2.14419"/>
        <FeComposite in2="hardAlpha" operator="out"/>
        <FeColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
        <FeBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_168_4138"/>
        <FeBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_168_4138" result="shape"/>
      </Filter>
    </Defs>
  </Svg>
);

export const ProgressBar = ({ currentPhase, totalPhases, phaseProgress }: ProgressBarProps) => {
  const insets = useSafeAreaInsets();
  const animatedStyle = useAnimatedStyle(() => ({
    width: withTiming(`${phaseProgress * 100}%`, { duration: 300 }),
  }));

  return (
    <View className="absolute left-0 right-0 top-0 z-10 flex-row items-center justify-center px-4" style={{ paddingTop: insets.top }}>
      <View className="flex-row items-center justify-center">
        {Array.from({ length: totalPhases }).map((_, index) => (
          <React.Fragment key={index}>
            {index < currentPhase ? (
              <View className="h-[46px] w-[46px] -rotate-6 z-50 flex items-center justify-center">
                <ValidateIcon />
              </View>
            ) : index === currentPhase ? (
              <View className="h-[48px] w-[48px] rotate-11 z-50 flex items-center justify-center">
                <CurrentIcon />
              </View>
            ) : (
              <View
                className="h-9 w-9 rounded-full z-50"
                style={{
                  backgroundColor: COLORS.background
                }}
              />
            )}
            {index < totalPhases - 1 && (
              <View className="relative w-[80px] h-[46px] flex items-center justify-center -ml-1 -mr-1">
                <View 
                  className="h-2.5 w-full justify-center z-0"
                  style={{
                    backgroundColor: COLORS.background
                  }}
                >
                  <Animated.View 
                    className="h-1.5 z-0"
                    style={[
                      index === currentPhase ? animatedStyle : { width: `${index < currentPhase ? 100 : 0}%` },
                      {
                        backgroundColor: index < currentPhase 
                          ? `${COLORS.completed}`
                          : index === currentPhase 
                          ? COLORS.completed
                          : 'transparent'
                      }
                    ]}
                  />
                </View>
              </View>
            )}
          </React.Fragment>
        ))}
      </View>
    </View>
  );
}; 